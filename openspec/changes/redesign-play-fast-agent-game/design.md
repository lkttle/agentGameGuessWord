## Context

该变更要解决当前 `play` 页“开局链路长、动作多、观战导向重”的体验问题，将玩法重心调整为“登录后快速开战”。现有项目已经具备房间、对局、Agent 回合、结果页等基础能力，但入口层仍要求用户额外输入房间 ID 与显示名称，不符合年轻用户的即时反馈预期，也拉低了 A2A 对战的启动效率。

本次设计同时受以下约束：
- 必须基于已登录账号（SecondMe OAuth）进行身份映射，避免重复命名。
- 必须保留 A2A 核心价值，让每个登录用户可直接使用自己的 Agent 参战。
- 必须兼容现有 API/引擎主干，优先重构流程与模型，而非推翻实现。
- 需支持从 1v1 过渡到多 Agent 参战，且不引入过重基础设施。

## Goals / Non-Goals

**Goals:**
- 将 `/play` 重构为两步内可开局：选择模式 → 一键开战。
- 以登录用户资料自动注入玩家展示身份，移除手动“显示名称”输入。
- 将“观战”能力弱化为“以自身 Agent 参与对局”的主动参战路径。
- 支持三类核心对局拓扑：`Human vs Platform Agent`、`Human vs Self Agent`、`Multi-Agent Battle`。
- 在不破坏现有结果页与轮询体系前提下，扩展多参战方状态表示和回合调度。

**Non-Goals:**
- 不在本轮实现实时推送基础设施（WebSocket/SSE 全面替换）。
- 不在本轮实现复杂匹配大厅、天梯分层、赛季系统。
- 不在本轮实现观战社区功能（弹幕、聊天室、围观位管理）。
- 不在本轮引入新的前端框架或大型状态管理库。

## Decisions

1. **入口改为“模式驱动开局”，不再要求手填房间 ID**
   - 决策：`/play` 首屏提供模式卡片与可选参数（Agent 数量/难度），点击后由后端自动创建或分配房间并返回跳转信息。
   - 原因：降低用户首次动作数，符合“短平快”目标。
   - 备选方案：继续保留手动房间 ID 输入作为主入口（灵活但摩擦高）。

2. **玩家身份绑定账户资料，显示名由服务端统一生成**
   - 决策：加入房间时优先使用 OAuth 用户名（或 profile name），前端仅展示可编辑别名入口（非必填），默认无需输入。
   - 原因：减少表单步骤并保持身份一致性。
   - 备选方案：前端继续强制用户输入显示名（实现简单但重复劳动）。

3. **观战能力并入“代理参战”，默认鼓励参战而非旁观**
   - 决策：将原“观战”文案与入口替换为“让我的 Agent 加入”，对局中每位登录用户都可携带自身 Agent 作为参战实体。
   - 原因：更贴合 A2A 场景价值，也更利于用户感知“我在参与”。
   - 备选方案：保留观战主入口并新增参战入口（信息层级更复杂）。

4. **统一参战方模型以支持多 Agent 拓扑**
   - 决策：对局参与者抽象为 `Participant`（`type: human | agent`，`ownerUserId`，`agentSource: self | platform`，`seat`，`status`），所有模式共用一套状态结构。
   - 原因：避免为每种模式维护独立数据结构，降低扩展成本。
   - 备选方案：1v1 与多 Agent 分离建模（初期快，但后续维护成本高）。

5. **回合调度改为“可变参战方轮转”而非双人硬编码**
   - 决策：`orchestrator` 按 `activeParticipants` 动态轮转，Human 回合等待输入，Agent 回合由策略执行；对掉线/超时参与者支持跳过与兜底。
   - 原因：为多人混战提供确定性执行路径。
   - 备选方案：仅在 UI 层模拟多人，后端仍按 1v1 执行（会导致语义不一致）。

6. **渐进兼容 API：新增可选字段而非破坏式改造**
   - 决策：在现有房间/开局接口上新增 `mode`、`participantsConfig`、`autoJoinSelfAgent` 等可选参数；旧调用路径仍可运行。
   - 原因：减少回归风险，支持前后端分步上线。
   - 备选方案：一次性替换所有接口契约（一致性高但迁移风险大）。

## Risks / Trade-offs

- [自身 Agent 可用性受外部平台状态影响] → 提供平台 Agent 自动降级路径，并清晰提示原因。
- [多 Agent 对局导致单局时长上升] → 设置最大参战 Agent 数（MVP 建议 3-4）与回合超时上限。
- [入口简化后高级操作入口不明显] → 将“高级房间设置”折叠到次级面板，默认隐藏。
- [兼容旧接口期间语义分叉] → 通过 `mode` 驱动统一服务端逻辑，减少分支散落。
- [观战弱化可能影响部分展示诉求] → 在结果页与战斗日志中增强“对局可视化”替代围观感。

## Migration Plan

1. 调整 `play` 首屏信息架构：移除必填房间 ID/显示名输入，改为模式卡片 + 快速开局按钮。
2. 扩展房间创建/加入 API 参数，打通账户身份自动注入与自身 Agent 自动参战。
3. 更新房间状态模型与前端轮询解析，支持多参战方结构。
4. 升级 `guess-word-engine` 与 `orchestrator` 的回合轮转逻辑，覆盖多人对局。
5. 对旧 1v1 流程做兼容验证，确保现有结果页/结算接口不回退。
6. 增加核心埋点（开局耗时、模式分布、完局率）并与旧口径对齐。

回滚策略：
- 通过 feature flag 保留旧入口与旧模式；若新流程异常，立即切回旧 `play` 路径。
- API 新字段保持可选，回滚时忽略新字段即可恢复旧行为。

## Open Questions

- 自身 Agent vs 自身（训练模式）是否允许记入公共排行榜，还是仅记录个人战绩？
- 多 Agent 对局默认人数应设为 3 还是 4，哪一档更平衡“快节奏”和“策略性”？
- 是否需要提供“邀请其他登录用户 Agent 参战”的显式入口，还是先仅支持平台 Agent + 自身 Agent？
- 在不开启观战入口的前提下，是否要在房间页增加“实时战报卡片”强化可看性？
