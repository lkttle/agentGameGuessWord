## Context

项目当前 Agent 回合在 `human-move` 与 `agent-round` 接口内逐个实时请求 SecondMe Chat/TTS。题库已扩展到 100 题，若并发玩家和 Agent 增多，实时链路会导致首轮延迟和回合抖动。为了满足“进入首页就开始缓存、登录新账号立即缓存、对局优先用缓存”的目标，需要在后端增加可去重、可持续补齐、可并发保护的缓存预热机制。

## Goals / Non-Goals

**Goals:**
- 为每个可用 SecondMe 用户与每道题建立唯一缓存，保存文本答复和语音内容。
- 首页触发全量补齐，新登录用户触发定向补齐。
- 对局时优先读取缓存，未命中时实时生成并立即写回缓存。
- 在题目生成端降低短周期重复概率，减少“连续刷到同题”。
- 控制并发，避免同一用户同一题被重复缓存。

**Non-Goals:**
- 不引入独立消息队列/Worker 基础设施（先用应用内批处理与轻量锁）。
- 不在本变更中重写 room 前端回合机制。
- 不实现跨多实例强一致分布式锁（先用唯一键 + 进程内互斥 + 幂等）。

## Decisions

1. **新增 `AgentQuestionCache` 表作为缓存主存储**
   - 决策：用 `userId + questionKey` 唯一约束保证“不重复缓存同题”，并保存文本答复、语音 data url/source url、状态与错误信息。
   - 原因：数据库天然幂等，便于后续统计命中率和补偿重试。
   - 备选：仅内存缓存（重启丢失且多实例不可用）。

2. **预热采用“批处理 + 后台触发 + 幂等补齐”策略**
   - 决策：提供服务函数按批次扫描“用户 × 题库”，跳过已 READY 记录，仅处理缺口；首页和登录事件都触发该流程。
   - 原因：避免单次请求超长；支持渐进式把全量缓存补齐。
   - 备选：一次性全量同步阻塞执行（易超时）。

3. **并发控制以“进程内锁 + 唯一键冲突兜底”为主**
   - 决策：预热作业采用全局运行锁，单条缓存采用 in-flight 键防重；数据库唯一键保证最终不重复。
   - 原因：实现复杂度低，足够应对当前部署规模。
   - 备选：数据库行锁/分布式锁（复杂度高，迭代成本高）。

4. **对局链路改为“缓存优先，实时回填”**
   - 决策：`SecondMeAgentTurnClient` 在有题目信息时先读缓存，未命中再走 Chat+TTS 并写库。
   - 原因：复用现有调用入口，改动最小；可立即改善回合时延。
   - 备选：在各 route 重复写缓存逻辑（易分叉）。

5. **题目抽取增加近期去重窗口**
   - 决策：在 `generatePinyinQuestions` 内维护近期题目 key 窗口；当可选题量充足时优先选择窗口外题目。
   - 原因：不改 API 协议即可降低重复率。
   - 备选：由前端携带历史题排除列表（前后端耦合更高）。

## Risks / Trade-offs

- [语音 data url 体积较大导致库膨胀] → 限制单音频最大字节数，超限时仅存 source url 并记录状态。
- [后台预热未完全跑完] → 对局保留实时兜底并回填缓存，保证功能正确性。
- [多实例并发触发同一缓存任务] → 唯一键约束 + 幂等 upsert 防止重复记录。
- [外部 SecondMe API 波动] → 缓存记录失败状态与错误信息，后续批次自动重试。

## Migration Plan

1. 新增 Prisma 模型与迁移，执行 `prisma generate`。
2. 实现缓存服务（读取/写入/预热/并发保护）。
3. 接入登录回调与首页触发。
4. 接入 Agent 回合缓存优先路径。
5. 接入题目近期去重随机策略。
6. 运行 typecheck/build，灰度验证后上线。

回滚策略：
- 保留实时 SecondMe 调用兜底；回滚时只需移除缓存读写入口。
- 数据表可保留不影响旧逻辑运行。

## Open Questions

- 是否需要后续引入定时任务，确保长时间无人访问首页时也能持续补齐缓存？
- 语音缓存是否需要分层策略（热门题 data url、长尾题仅 source url）以控制数据库体积？
