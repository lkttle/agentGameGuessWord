## Context

本变更面向 2026-02-12 黑客松提交窗口，目标是在极短周期内交付可公开访问的 A2A 猜词游戏 MVP。当前 proposal 已明确 7 个新能力：OAuth 登录、房间生命周期、猜词引擎、Agent 编排、人机对战、榜单分享、基础指标采集。

约束条件：
- 必须满足 A2A 场景可演示（Agent vs Agent 为核心链路）。
- 必须接入 SecondMe OAuth 以对齐赛事用户统计口径。
- 必须在线可访问，且在演示中可稳定完成“登录-开局-结算-分享”闭环。
- 开发时间紧，优先可交付和稳定性，避免引入高复杂度基础设施。

关键干系人：开发团队（交付速度）、评审（A2A 价值与完成度）、终端玩家（可玩性与分享体验）。

## Goals / Non-Goals

**Goals:**
- 在单一 Next.js 项目中完成前后端 MVP 闭环，降低部署与联调成本。
- 提供可重复执行的 Agent vs Agent 自动对战流程，支持超时兜底与稳定结算。
- 提供 Human vs Agent 可玩入口，并复用同一规则引擎与结算逻辑。
- 落地最小可用数据模型，支撑房间管理、对局记录、排行榜与分享。
- 提供基础可观测性（登录数、开局数、完局率），支撑增长展示。

**Non-Goals:**
- 不实现复杂实时通信（如 WebSocket 集群、多人并发观战聊天室）。
- 不实现高级匹配机制（Elo、跨赛季段位）与反作弊系统。
- 不引入复杂微服务拆分或多区域高可用架构。
- 不在 MVP 阶段承诺语音播报、弹幕系统等加分项。

## Decisions

1. **采用 Next.js 全栈架构（页面 + API Routes）**
   - 决策：前端、业务 API、OAuth 回调统一在 Next.js 中实现，部署到 Vercel。
   - 选择原因：上线路径最短、环境一致、便于在截止前快速迭代。
   - 备选方案：
     - 前后端分离（Next.js + 独立 Node 服务）：灵活但部署与联调复杂度更高。
     - Serverless 多函数拼接：函数粒度更细，但状态编排与调试成本上升。

2. **使用“状态机驱动”的对战引擎与回合编排**
   - 决策：将对局抽象为确定性状态机（WAITING -> RUNNING -> FINISHED），每回合执行统一步骤：输入收集 -> 判定 -> 计分 -> 下一回合。
   - 选择原因：便于实现超时、重试、幂等结算，降低边界条件错误。
   - 备选方案：
     - 纯前端控制回合：实现快但容易被中断，数据一致性差。
     - 事件驱动异步队列：扩展性高，但对 MVP 过重。

3. **SecondMe OAuth token 仅服务端持有，前端仅保留会话标识**
   - 决策：OAuth 回调后在服务端安全存储 access/refresh token，前端通过 session cookie 或会话 ID 访问。
   - 选择原因：降低 token 泄漏风险，符合后续安全扩展路径。
   - 备选方案：
     - 前端直持 token：接入更快，但安全风险高且不利于审计。

4. **MVP 实时性采用短轮询（polling），预留升级到 SSE**
   - 决策：客户端每 1-2 秒拉取房间/对局状态；接口层预留事件流抽象，后续可切 SSE。
   - 选择原因：实现简单、兼容性高，满足演示实时感需求。
   - 备选方案：
     - WebSocket：交互更实时，但连接管理和部署调优更复杂。
     - SSE：实现中等复杂，若当前时间不足会影响主链路。

5. **排行榜在“对局结算”时同步更新，避免离线批处理依赖**
   - 决策：match finish 事务内写入积分与榜单快照，支持日榜/总榜查询。
   - 选择原因：减少后台任务依赖，保证演示时数据即时可见。
   - 备选方案：
     - 定时任务聚合：更利于大规模，但会引入延迟与运维点。

6. **最小数据模型优先，避免过度建模**
   - 决策：核心实体限定为 `User`、`Room`、`Match`、`RoundLog`、`LeaderboardEntry`、`MetricEvent`。
   - 选择原因：兼顾可追溯与交付速度，支撑 MVP 功能全链路。
   - 备选方案：
     - 全量事件溯源：灵活但开发与查询复杂度显著上升。

## Risks / Trade-offs

- [OAuth 接入进度不确定] → 先实现本地 mock 登录与回调桩，OAuth 可用后无缝切换 provider。
- [Agent 推理延迟导致回合超时] → 设置单回合超时与默认策略（跳过/保底答案），确保对局可结束。
- [轮询带来额外请求压力] → 控制刷新频率、仅在 RUNNING 状态高频拉取，结束后降频。
- [规则边界导致争议判定] → 固化判定优先级（精确匹配 > 近似匹配 > 错误），并记录回合日志可复盘。
- [截止日前功能蔓延] → 严格按 MVP 清单冻结，非核心特性进入 backlog。

## Migration Plan

1. 初始化数据库表与索引（User、Room、Match、RoundLog、LeaderboardEntry、MetricEvent）。
2. 部署 OAuth 回调与会话管理，验证登录闭环。
3. 上线对战引擎与房间 API，先打通 Agent vs Agent 主链路。
4. 接入 Human vs Agent 页面与交互接口。
5. 启用榜单与分享页，补充基础埋点。
6. 预发布演练（至少 3 次完整 Demo），修复阻断问题后正式发布。

回滚策略：
- 接口回滚：按模块开关关闭新入口（如禁用房间创建、隐藏榜单页）。
- 数据回滚：对新增表仅做只读保留，不做破坏性删除；必要时回退到上一个稳定镜像。
- OAuth 异常兜底：切换到 mock 登录仅供演示（若比赛规则允许），并在提交说明中标记。

## Open Questions

- 词库来源与审核机制是否需要在 MVP 就支持动态更新？
- Human vs Agent 模式中，是否允许玩家请求额外提示（会影响平衡性）？
- 榜单是否采用“按登录用户去重”或“按局数累计”作为主展示口径？
- 是否需要在提交前加入最小观战页（只读轮询），以增强 A2A 可视化表现？
