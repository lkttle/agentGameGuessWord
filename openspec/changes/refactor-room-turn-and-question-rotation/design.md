## Context

当前房间页将“题目轮转、当前轮到谁、超时跳过、换题”主要放在前端内存状态管理，同时后端 `human-move`/`agent-round` 仍保留批处理式旧逻辑（一次请求可能串行多个 Agent）。这会造成以下高风险：
- 回合推进语义不一致：前端按单人轮转，后端接口仍可多人批处理。
- 题目一致性脆弱：接口校验依赖客户端传入 `targetWord`，缺少稳定的题目标识约束。
- 超时行为不闭环：玩家超时直接前端跳过，未形成统一日志语义。

本次改造目标是把玩法约束固化为一致协议：固定席位、单次单参与者回合、20 秒超时推进、答对即换题、整轮无人答对揭晓并换题。

## Goals / Non-Goals

**Goals:**
- 固定参战头像顺序，按 seat 顺序展示，不随分数重排。
- 回合执行统一为“单参与者单回合”，移除批处理旧逻辑。
- 玩家超时也写入回合日志，保证 UI 与统计一致。
- 通过 `questionKey` 校验题面一致性，避免“提示与作答题目不一致”。
- 满足完整轮转语义：A→B→C→D；答对立即换题且下一位接新题；整轮无人答对则揭晓后换题。

**Non-Goals:**
- 不引入 WebSocket/SSE 实时同步架构。
- 不新增数据库表/字段（本轮使用现有 `RoundLog` 表达超时与得分）。
- 不重做房间/对局页面视觉结构，仅修正行为一致性。

## Decisions

1. **后端接口改为严格单人回合语义**
   - 决策：`human-move` 仅处理当前玩家一次作答（或超时）；`agent-round` 仅处理指定单个 Agent 一次作答。
   - 原因：与 seat 轮转玩法一一对应，消除“一个请求触发多人行为”的不确定性。
   - 备选：保留批处理并在前端拆分（仍会带来并发冲突与行为歧义）。

2. **`questionKey` 作为题目一致性主锚点**
   - 决策：后端从 `questionKey` 解析标准题面（首字母/答案/分类），客户端传入的 `targetWord/pinyinHint/categoryHint` 仅用于兼容比对。
   - 原因：避免客户端局部状态漂移导致“旧题答案回答新题”的错配。
   - 备选：仅相信客户端 `targetWord`（安全性与一致性不足）。

3. **玩家超时写日志而非仅本地跳过**
   - 决策：新增 `timedOut` 提交路径，落库 `RoundLog.timedOut=true`，`scoreDelta=0`。
   - 原因：保证所有回合推进均可追溯，便于 UI 展示与后续指标统计。
   - 备选：继续仅前端跳过（难以诊断与复盘）。

4. **前端用 seat 顺序渲染玩家栏，排名单独计算**
   - 决策：玩家卡片展示按 `seatOrder` 固定，分数排名仅作为卡片上的名次标签。
   - 原因：符合“头像栏固定不动”的玩法预期，降低视觉跳变。
   - 备选：继续按分数排序渲染（与需求冲突）。

5. **整轮无人答对时在前端揭晓上一题答案并换题**
   - 决策：在完成一轮（所有 seat 都答过）且无人答对时，先展示“本轮答案”，再切换新题。
   - 原因：满足玩法 7 且不增加后端状态复杂度。
   - 备选：后端写系统消息日志（需要扩展日志模型与渲染协议）。

## Risks / Trade-offs

- [前端仍是题目切换主驱动，刷新页可能丢失当前题] → 通过 `questionKey` 做提交校验，至少保证不会把旧题答案写进新题。
- [超时自动提交与用户手动提交的竞态] → 复用 `isSubmitting/runningAction` 互斥门禁，避免重复提交。
- [旧调用方未传 `participantId`/`questionKey`] → 接口返回明确 400，促使调用方迁移到单回合协议。

## Migration Plan

1. 完成 OpenSpec 变更 artifacts（proposal/design/spec/tasks）。
2. 改造 `human-move`：移除自动 Agent 批处理；新增 `timedOut`；基于 `questionKey` 解析题面。
3. 改造 `agent-round`：强制 `participantId` 且仅执行单 Agent 回合。
4. 改造房间页：
   - 固定 seat 顺序渲染头像栏；
   - 玩家超时调用后端落日志；
   - 整轮无人答对时揭晓答案后换题。
5. 执行 `npm run typecheck` 验证。
6. 勾选 tasks 并提交 commit/push。

回滚策略：
- 若新协议导致异常，可回滚本次提交恢复旧接口与前端轮转行为。

## Open Questions

- 是否需要把“题目当前状态”持久化到服务端，支持刷新后无缝恢复同一题？
- 超时是否需要在 UI 上区分“输入超时”与“Agent 生成超时”两种提示文案？
