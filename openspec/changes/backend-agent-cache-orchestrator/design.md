## Context

现有缓存体系已经具备数据库缓存与缓存优先读取基础能力，但仍有前端首页触发预热逻辑，且预热批次按串行处理 pair，速度较慢。目标是把缓存调度完全后移至后端，通过统一入口触发、并发 worker、失败重试和防重机制实现“尽快覆盖题库”。

## Goals / Non-Goals

**Goals:**
- 前端不再承担缓存预热触发职责。
- 后端统一触发并编排缓存任务，确保缓存优先、实时兜底、写回缓存。
- 对已登录 agent 尽快补齐全题库，对新加入 agent 触发全量训练。
- 引入并发 worker 与重试，提升吞吐并控制重复缓存。

**Non-Goals:**
- 不引入外部 MQ/独立 Worker 集群。
- 不改动 room 前端展示交互。

## Decisions

1. **移除首页前端触发，改为后端会话链路触发**
   - 决策：删除 `src/app/page.tsx` 的预热请求逻辑；在后端会话接口命中已登录用户后自动触发全局+用户预热。
   - 原因：降低前端耦合，统一后端治理。

2. **预热任务改为并发 worker 池**
   - 决策：使用可配置并发 worker（默认 4）消费待缓存 pair 列表。
   - 原因：相比串行显著提高吞吐。

3. **失败重试与幂等防重并存**
   - 决策：每个 pair 支持最多 N 次重试（默认 2）；同时保留 `inFlightPairs` + 数据库唯一键防重复缓存。
   - 原因：兼顾速度与安全，避免重复写和并发竞态。

4. **后端全题库覆盖策略**
   - 决策：预热默认扫描 eligible users × question bank 的缺口组合并补齐，不再只做极小批。
   - 原因：满足“尽快覆盖全题库”的产品目标。

## Risks / Trade-offs

- [并发提高导致外部 API 压力上升] → 增加并发配置项与重试上限，默认保守值。
- [后台任务过长] → 触发接口异步返回，任务在后端后台运行并可重复触发补齐。
- [多实例竞态] → 依赖唯一键和 in-flight 锁保持幂等。
